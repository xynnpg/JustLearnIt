{% extends "studio_base.html" %}

{% block title %}Edit Test: {{ test }} - JustLearnIt{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .test-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f7fa;
    }

    .test-header {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .test-title {
        margin: 0;
        font-size: 1.8rem;
        color: #333;
    }

    .test-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .question-card {
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        border: 1px solid #eee;
        border-radius: 8px;
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .question-type {
        padding: 0.25rem 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
        color: #666;
        font-size: 0.9rem;
    }

    .question-text {
        margin-bottom: 1rem;
        color: #333;
    }

    .options-container {
        margin-top: 1rem;
    }

    .option-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .correct-option {
        background: #d4edda;
        border-color: #c3e6cb;
    }

    .action-buttons {
        margin-top: 2rem;
        display: flex;
        gap: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .btn i {
        font-size: 1rem;
    }

    .btn-primary {
        background: #7808d0;
        color: white;
    }

    .btn-primary:hover {
        background: #6a07b8;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-info:hover {
        background: #138496;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    /* Editor styles */
    .question-editor, .option-editor {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 1rem;
        min-height: 150px;
    }

    .ql-toolbar {
        background: #f8f9fa !important;
        border-top-left-radius: 4px !important;
        border-top-right-radius: 4px !important;
    }

    .ql-container {
        border-bottom-left-radius: 4px !important;
        border-bottom-right-radius: 4px !important;
        min-height: 150px !important;
    }

    .ql-editor {
        color: #333 !important;
        font-size: 16px !important;
        line-height: 1.6 !important;
        min-height: 150px !important;
    }

    .ql-editor p {
        margin-bottom: 1em !important;
    }

    .ql-editor h1,
    .ql-editor h2,
    .ql-editor h3,
    .ql-editor h4,
    .ql-editor h5,
    .ql-editor h6 {
        color: #333 !important;
        margin-top: 1.5em !important;
        margin-bottom: 0.5em !important;
    }

    .ql-editor ul,
    .ql-editor ol {
        margin-bottom: 1em !important;
        padding-left: 2em !important;
    }

    .ql-editor img {
        max-width: 100% !important;
        height: auto !important;
        margin: 1em 0 !important;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #333;
    }

    .form-select {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
        color: #333;
        font-size: 1rem;
    }

    .form-select:focus {
        outline: none;
        border-color: #7808d0;
        box-shadow: 0 0 0 2px rgba(120, 8, 208, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <div class="test-header">
        <div class="header-content">
            <h1 class="test-title">
                <i class="fas fa-question-circle"></i>
                Edit Test: {{ test }}
            </h1>
            <div class="user-info">
                <span class="badge badge-primary">{{ subject }}</span>
                <img src="https://ui-avatars.com/api/?name={{ user.name|urlencode }}&background=7808d0&color=fff" class="avatar" alt="Profile">
            </div>
        </div>
    </div>

    <div class="test-content card">
        <form id="test-form" method="POST" action="{{ url_for('studio.edit_test', subject=subject, test=test) }}">
            <input type="hidden" name="test_content" id="test-content-input">
            <div id="questions-container">
                {% for question in content.questions %}
                <div class="question-card card">
                    <div class="question-header">
                        <select class="question-type form-select">
                            <option value="multiple_choice" {% if question.type == 'multiple_choice' %}selected{% endif %}>Multiple Choice</option>
                            <option value="short_answer" {% if question.type == 'short_answer' %}selected{% endif %}>Short Answer</option>
                            <option value="essay" {% if question.type == 'essay' %}selected{% endif %}>Essay</option>
                        </select>
                        <button type="button" class="btn btn-danger remove-question-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="question-body">
                        <div class="form-group">
                            <label>Question Content</label>
                            <div class="question-editor">{{ question.content|safe }}</div>
                        </div>
                        <div class="options-container" {% if question.type != 'multiple_choice' %}style="display: none;"{% endif %}>
                            {% for option in question.options %}
                            <div class="option-item">
                                <input type="radio" name="correct-{{ loop.index0 }}" class="correct-option" {% if loop.index0 == question.correctIndex %}checked{% endif %}>
                                <div class="option-editor">{{ option|safe }}</div>
                                <button type="button" class="btn btn-danger remove-option-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% endfor %}
                            <button type="button" class="btn btn-info add-option-btn">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="action-buttons">
                <button type="button" id="add-question" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Question
                </button>
                <button type="button" id="save-test" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Test
                </button>
                <a href="{{ url_for('studio.tests', subject=subject) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Tests
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Delete Test</h2>
            <button class="modal-close" id="cancel-delete">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <p>Are you sure you want to delete this test? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-btn">Cancel</button>
            <form method="POST" action="{{ url_for('studio.delete_test', subject=subject, title=test) }}" style="display: inline;">
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Question Template -->
<template id="question-template">
    <div class="question-card card">
        <div class="question-header">
            <select class="question-type form-select">
                <option value="multiple_choice">Multiple Choice</option>
                <option value="short_answer">Short Answer</option>
                <option value="essay">Essay</option>
            </select>
            <button type="button" class="btn btn-danger remove-question-btn">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="question-body">
            <div class="form-group">
                <label>Question Content</label>
                <div class="question-editor"></div>
            </div>
            <div class="options-container" style="display: none;">
                <div class="option-item">
                    <input type="radio" name="correct-{id}" class="correct-option">
                    <div class="option-editor"></div>
                    <button type="button" class="btn btn-danger remove-option-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <button type="button" class="btn btn-info add-option-btn">
                    <i class="fas fa-plus"></i> Add Option
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Option Template -->
<template id="option-template">
    <div class="option-item">
        <input type="radio" name="correct-{questionIndex}" value="{optionIndex}">
        <div class="option-editor"></div>
        <button type="button" class="btn btn-danger btn-sm delete-option">
            <i class="fas fa-times"></i>
        </button>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    window.testData = {{ content|tojson|safe }};
</script>
<script src="{{ url_for('static', filename='js/test_editor.js') }}"></script>
{% endblock %} 